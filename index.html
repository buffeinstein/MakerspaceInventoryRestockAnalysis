<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Makerspace Restocks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Plotly CDN -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
    .controls { display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; max-width: 780px; margin-bottom: 16px; }
    label { font-size: 14px; color: #333; }
    input[type="date"] { padding: 8px; font-size: 14px; }
    button { padding: 10px 14px; font-size: 14px; border-radius: 8px; border: 1px solid #ddd; background: #111; color: #fff; cursor: pointer; }
    button:hover { filter: brightness(1.05); }
    #legend { margin: 8px 0 0; font-size: 12px; color: #444; }
    #chart { width: 100%; max-width: 1100px; height: 520px; }
    .note { font-size: 12px; color: #666; margin-top: 6px; }
  </style>
</head>
<body>
  <h1>Makerspace Restocks</h1>
  <div class="controls">
    <div>
      <label for="start">Start date</label><br />
      <input id="start" type="date" />
    </div>
    <div>
      <label for="end">End date</label><br />
      <input id="end" type="date" />
    </div>
    <div style="display:flex; align-items:end;">
      <button id="plotBtn">Plot</button>
    </div>
  </div>
  <div id="chart"></div>
  <div id="legend" class="note">Tip: dates are mapped to ISO weeks (Mon–Sun). Weeks with no requests simply don’t appear.</div>

  <script>
    // === Modebar config: keep PNG, zoomIn/zoomOut, pan, autoscale; remove zoom (box), reset axes, box select, lasso ===
    const PLOT_CONFIG = {
      displaylogo: false,
      responsive: true,
      modeBarButtonsToRemove: [
        'zoom2d',       // box-zoom (removed)
        'resetScale2d', // reset axes (removed)
        'select2d',     // box select (removed)
        'lasso2d'       // lasso select (removed)
      ],
      // The following stay available by *not* removing them:
      // 'toImage' (Download PNG), 'zoomIn2d', 'zoomOut2d', 'pan2d', 'autoScale2d'
      toImageButtonOptions: {
        format: 'png',
        filename: 'makerspace-restocks',
        height: 600,
        width: 1100,
        scale: 2
      }
    };

    // ---- Configurable colors per area (optional) ----
    const USER_COLOR_OVERRIDES = {
      // "Cabinet 3": "#1f77b4",
      // "Fabric": "#ff7f0e",
      // "Pegboard 1": "#2ca02c",
      // "Spraypaint": "#d62728",
      // "Cage/Crypt/Other": "#9467bd",
    };
    const PALETTE = [
      "#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd",
      "#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf",
      "#aec7e8","#ffbb78","#98df8a","#ff9896","#c5b0d5",
      "#c49c94","#f7b6d2","#c7c7c7","#dbdb8d","#9edae5"
    ];

    let weeksData = null;
    let weekMap = null; // key: `${iso_year}-W${iso_week}` → record

    // ISO utils
    function isoWeekYear(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
      return d.getUTCFullYear();
    }
    function isoWeek(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    function mondayOfWeek(date) {
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const day = d.getDay(); // 0=Sun..6=Sat
      const diff = (day === 0 ? -6 : 1 - day);
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }
    function iterateWeeks(startDate, endDate) {
      const weeks = [];
      let cur = mondayOfWeek(startDate);
      const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
      end.setHours(23,59,59,999);
      while (cur <= end) {
        const y = isoWeekYear(cur);
        const w = isoWeek(cur);
        weeks.push({ iso_year: y, iso_week: w, key: `${y}-W${String(w).padStart(2, "0")}`, label: `W${w} (${y})` });
        cur = new Date(cur.getFullYear(), cur.getMonth(), cur.getDate() + 7);
      }
      return weeks;
    }

    async function loadData() {
      const res = await fetch("weeks.json", { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load weeks.json");
      const payload = await res.json();
      weeksData = payload.weeks || [];
      weekMap = new Map(weeksData.map(w => [`${w.iso_year}-W${String(w.iso_week).padStart(2, "0")}`, w]));
    }

    function buildColorMap(locations) {
      const colorMap = {};
      let i = 0;
      for (const loc of locations) {
        colorMap[loc] = USER_COLOR_OVERRIDES[loc] || PALETTE[i % PALETTE.length];
        i++;
      }
      return colorMap;
    }

    // function plotRange(startDate, endDate) {
    //   const weeksInRange = iterateWeeks(startDate, endDate);
    //   const present = weeksInRange
    //     .map(meta => ({ meta, rec: weekMap.get(meta.key) }))
    //     .filter(x => !!x.rec);

    //   if (present.length === 0) {
    //     Plotly.react("chart", [], {
    //       title: "No data in the selected range",
    //       xaxis: { title: "ISO Week" },
    //       yaxis: { title: "Number of Restocks" }
    //     }, PLOT_CONFIG);
    //     return;
    //   }

    //   const allLocations = Array.from(new Set(present.flatMap(x => Object.keys(x.rec.counts)))).sort();
    //   const colorMap = buildColorMap(allLocations);

    //   const x = present.map(x => x.meta.label);
    //   const totals = present.map(x => Object.values(x.rec.counts).reduce((a,b)=>a+b,0));
    //   const avgDelays = present.map(x => x.rec.avg_delay_days);

    //   const traces = allLocations.map(loc => ({
    //     type: "bar",
    //     name: loc,
    //     x,
    //     y: present.map(x => x.rec.counts[loc] || 0),
    //     marker: { color: colorMap[loc] },
    //     hovertemplate: `Week %{x}<br>Area: ${loc}<br>Count: %{y}<extra></extra>`
    //   }));

    //   const layout = {
    //     barmode: "stack",
    //     title: `Makerspace Restocks — ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`,
    //     xaxis: { title: "ISO Week", tickangle: -30 },
    //     yaxis: { title: "Number of Restocks" },
    //     legend: { title: { text: "Area" } },
    //     margin: { l: 50, r: 20, t: 60, b: 80 },
    //     hovermode: "x unified"
    //   };

    //   Plotly.react("chart", traces, layout, PLOT_CONFIG).then(() => {
    //     const ann = [];
    //     for (let i = 0; i < x.length; i++) {
    //       const total = totals[i];
    //       if (total > 0) {
    //         const delay = avgDelays[i];
    //         const label = (typeof delay === "number") ? `${Math.round(delay)}d` : "–";
    //         ann.push({
    //           x: x[i],
    //           y: total,
    //           text: label,
    //           showarrow: false,
    //           yshift: 12,
    //           font: { size: 12 }
    //         });
    //       }
    //     }
    //     Plotly.relayout("chart", { annotations: ann });
    //   });
    // }




//     function plotRange(startDate, endDate) {
//     const weeksInRange = iterateWeeks(startDate, endDate);
//     const present = weeksInRange
//       .map(meta => ({ meta, rec: weekMap.get(meta.key) }))
//       .filter(x => !!x.rec);

//     if (present.length === 0) {
//       Plotly.react("chart", [], {
//         title: "No data in the selected range",
//         xaxis: { title: "ISO Week" },
//         yaxis: { title: "Number of Restocks" }
//       }, PLOT_CONFIG);
//       return;
//     }

//     const allLocations = Array.from(new Set(present.flatMap(x => Object.keys(x.rec.counts)))).sort();
//     const colorMap = buildColorMap(allLocations);

//     const x = present.map(x => x.meta.label);
//     const totals = present.map(x => Object.values(x.rec.counts).reduce((a,b)=>a+b,0));
//     const avgDelays = present.map(x => x.rec.avg_delay_days);

//     // Build traces with hover hidden for zeros
//     const traces = allLocations.map(loc => {
//       const counts = present.map(x => x.rec.counts[loc] || 0);
//       const hovertext = counts.map((c, i) =>
//         c > 0 ? `Week ${x[i]}<br>Area: ${loc}<br>Count: ${c}` : null
//       );
//       return {
//         type: "bar",
//         name: loc,
//         x,
//         y: counts,
//         marker: { color: colorMap[loc] },
//         hovertext: hovertext,
//         hoverinfo: "text" // only show our custom text; null entries show no tooltip
//       };
//     });

//     const layout = {
//       barmode: "stack",
//       title: `Makerspace Restocks — ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`,
//       xaxis: { title: "ISO Week", tickangle: -30 },
//       yaxis: { title: "Number of Restocks" },
//       legend: { title: { text: "Area" } },
//       margin: { l: 50, r: 20, t: 60, b: 80 },
//       hovermode: "x unified"
//     };

//     Plotly.react("chart", traces, layout, PLOT_CONFIG).then(() => {
//       const ann = [];
//       for (let i = 0; i < x.length; i++) {
//         const total = totals[i];
//         if (total > 0) {
//           const delay = avgDelays[i];
//           const label = (typeof delay === "number") ? `${Math.round(delay)}d` : "–";
//           ann.push({
//             x: x[i],
//             y: total,
//             text: label,
//             showarrow: false,
//             yshift: 12,
//             font: { size: 12 }
//           });
//         }
//       }
//       Plotly.relayout("chart", { annotations: ann });
//     });
//   }

function plotRange(startDate, endDate) {
    const weeksInRange = iterateWeeks(startDate, endDate);
    const present = weeksInRange
      .map(meta => ({ meta, rec: weekMap.get(meta.key) }))
      .filter(x => !!x.rec);

    if (present.length === 0) {
      Plotly.react("chart", [], {
        title: "No data in the selected range",
        xaxis: { title: "ISO Week" },
        yaxis: { title: "Number of Restocks" }
      }, PLOT_CONFIG);
      return;
    }

    const allLocations = Array.from(new Set(present.flatMap(x => Object.keys(x.rec.counts)))).sort();
    const colorMap = buildColorMap(allLocations);

    const x = present.map(x => x.meta.label);
    const totals = present.map(x => Object.values(x.rec.counts).reduce((a,b)=>a+b,0));
    const avgDelays = present.map(x => x.rec.avg_delay_days);

    // Build traces with hover hidden for zeros
    const traces = allLocations.map(loc => {
      const counts = present.map(x => x.rec.counts[loc] || 0);
      // For zero counts → set hoverinfo to "skip"
      const customHover = counts.map(c => c > 0 ? `Area: ${loc}<br>Count: ${c}` : null);

      return {
        type: "bar",
        name: loc,
        x,
        y: counts,
        marker: { color: colorMap[loc] },
        hovertext: customHover,
        hoverinfo: "text"  // only show our custom text; null = no hover at all
      };
    });

    const layout = {
      barmode: "stack",
      title: `Makerspace Restocks — ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`,
      xaxis: { title: "ISO Week", tickangle: -30 },
      yaxis: { title: "Number of Restocks" },
      legend: { title: { text: "Area" } },
      margin: { l: 50, r: 20, t: 60, b: 80 },
      hovermode: "x unified"
    };

    Plotly.react("chart", traces, layout, PLOT_CONFIG).then(() => {
      const ann = [];
      for (let i = 0; i < x.length; i++) {
        const total = totals[i];
        if (total > 0) {
          const delay = avgDelays[i];
          const label = (typeof delay === "number") ? `${Math.round(delay)}d` : "–";
          ann.push({
            x: x[i],
            y: total,
            text: label,
            showarrow: false,
            yshift: 12,
            font: { size: 12 }
          });
        }
      }
      Plotly.relayout("chart", { annotations: ann });
    });
  }





    // Wire up UI
    document.getElementById("plotBtn").addEventListener("click", () => {
      const s = document.getElementById("start").value;
      const e = document.getElementById("end").value;
      if (!s || !e) { alert("Please select both start and end dates."); return; }
      const start = new Date(s);
      const end = new Date(e);
      if (end < start) { alert("End date must be on/after start date."); return; }
      plotRange(start, end);
    });

    // Boot
    (async function init() {
      try {
        await loadData();
        const today = new Date();
        const defaultEnd = today;
        const defaultStart = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 70);
        document.getElementById("start").valueAsDate = defaultStart;
        document.getElementById("end").valueAsDate = defaultEnd;
        plotRange(defaultStart, defaultEnd);
      } catch (err) {
        console.error(err);
        document.getElementById("chart").innerText = "Failed to load data.";
      }
    })();
  </script>
</body>
</html>
